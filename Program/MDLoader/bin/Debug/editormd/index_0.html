<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8" />
    <title></title>
    <link rel="stylesheet" href="../editormd/css/style.css" />
    <link rel="stylesheet" href="../editormd/css/editormd.css" />
    <link rel="stylesheet" href="html2pdf.bundle.min.js"/>
    <style>
        @media print {
            .editormd-editor, .CodeMirror, .editormd-toolbar {
                display: none !important;
            }
                        /* 让预览区占满整个页面 */
            .editormd-preview {
                width: 100% !important;
                margin: 0 !important;
                padding: 0 0mm !important; /* 可调：边距 */
                box-sizing: border-box;
            }

            /* 去掉浏览器默认页眉页脚（部分浏览器可识别） */
            @page {
                margin: 0mm; /* 可改为 0 或 5mm 看效果 */
                size: auto;
            }

            html, body {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
            }
        }
</style>
</head>

<body>
    <div id="layout">

        <div id="test-editormd">
            <textarea style="display:none;">
</textarea>
        </div>
    </div>
    <script src="../editormd/js/jquery.min.js"></script>
    <script src="../editormd/editormd.js"></script>
    <script type="text/javascript">
        var testEditor;

        $(function () {
            testEditor = editormd("test-editormd", {
                id: "test-editormd",
                width: "100%",
                height: 800,
                syncScrolling: "single",
                path: "../editormd/lib/",
                placeholder: "请在这写Markdown代码...",
                toolbarIcons: function () {
                    // Or return editormd.toolbarModes[name]; // full, simple, mini
                    // Using "||" set icons align right.
                    return ["undo", "redo", "|",
                        "search", "|",
                        "bold", "del", "italic", "quote", "ucwords", "uppercase", "lowercase", "|",
                        "h1", "h2", "h3", "|",
                        "list-ul", "list-ol", "hr", "|",
                        "link", "reference-link", "image", "code", "preformatted-text", "code-block", "table", "datetime", "html-entities", "pagebreak", "|",
                        "watch", "preview", "|",
                        "help"]
                },
                htmlDecode: "style,script,iframe",
                taskList: true,
                flowChart: true,
                sequenceDiagram: true,
                // 指定 CodeMirror mode
                mode: "markdown",       // <-- 这里指定 mode
                onchange: function () {
                    //alert(window.external);  
                    window.external.OnContentChange();

                }
            });
            var w = $(document).height();
            testEditor.height(w)
        });
        //var int=self.setInterval("insertText()",1000);
        function insertText(txt) {
            testEditor.insertValue(txt);
        }

        function setClientSize(width, height) {
            //testEditor.width(width)
            testEditor.height(height)
        }

        function getSelectedText() {
            return testEditor.cm.getSelection();
        }

        function getTextBeforeSelection() {
            var cm = testEditor.cm; // editor.md 的 CodeMirror 实例
            var cursorStart = cm.getCursor("from"); // 选区起点
            return cm.getRange({ line: 0, ch: 0 }, cursorStart);
        }

        function replaceSelectedText(newText) {

            testEditor.replaceSelection(newText);  // 替换当前选中的文本            
        }


        function Redraw() {
            //alert("WebBrowser call!");

        }
        function Preview() {

        }
        function undoEditor() {
            //alert("Undo");
            testEditor.cm.undo();
        }
        
        document.addEventListener("contextmenu", function (event) {
            //event.preventDefault(); // 禁止默认右键菜单

            var x = event.clientX;
            var y = event.clientY;

            // 弹出坐标提示框
            //alert("右键点击位置：X = " + x + "，Y = " + y);
            window.external.OnRightClick(x, y)
        });

        function sendToHost(info) {
            // WinForms/WPF WebBrowser: window.external 必须暴露 ObjectForScripting
            try {
                // 传字符串（JSON）比较安全
                window.external && window.external.ReceiveKey(JSON.stringify(info));
                //alert(JSON.stringify(info));
            }
            catch (err) {
                console.warn("Send to host failed:", err);
            }
        }

        document.addEventListener("keydown", function (e) {
             isModifier = (e.key === "Control" || e.key === "Shift" || e.key === "Alt" || e.key === "Meta");
             hasModifier = e.ctrlKey || e.altKey || e.shiftKey || e.metaKey;

            if (hasModifier && !isModifier) {
                sendToHost({
                    key: e.key,
                    code: e.code,
                    ctrl: e.ctrlKey,
                    alt: e.altKey,
                    shift: e.shiftKey,
                    meta: e.metaKey,
                    time: Date.now()
                });
            }
        });
        function refreshImages() {
                        
            if (!testEditor) return;

            var cursor = testEditor.getCursor();

             preview = document.querySelector("#editor .editormd-preview");
            preview.querySelectorAll('img').forEach(function(img) {
                var src = img.getAttribute('src');
                if (src) {
                    img.src = src.split('?')[0] + '?t=' + Date.now();
                }
            });
            testEditor.setCursor(cursor);
        }
        function printPreview() {
            editArea = document.querySelector('.CodeMirror');
            previewArea = document.querySelector('.editormd-preview');
            // 创建一个 <style> 元素，用于控制打印样式
            printStyle = document.createElement('style');

            document.head.appendChild(printStyle);

            // 打印前调整可见性
            if (editArea) editArea.style.display = 'none';
            if (previewArea) previewArea.style.width = '100%';

            // 调用浏览器打印
            window.print();

            // 打印后恢复显示
            if (editArea) editArea.style.display = '';
            if (previewArea) previewArea.style.width = '';

            // 移除临时样式
            document.head.removeChild(printStyle);

        }

    </script>
</body>

</html>